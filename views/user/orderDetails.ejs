<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
    
    :root {
        --accent: #22c55e;
        --glass: #121513;
        --border: rgba(255, 255, 255, 0.05);
    }

    body {
        font-family: 'Plus Jakarta Sans', sans-serif;
        background-color: #050605;
        color: #ffffff;
        font-size: 14px;
    }

    .glass-card {
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 1rem;
    }

    .timeline-container::before {
        content: '';
        position: absolute;
        left: 7px;
        top: 10px;
        bottom: 10px;
        width: 1px;
        background: rgba(255, 255, 255, 0.1);
    }

    .step-dot {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #1a1d1b;
        border: 2px solid #2a2d2b;
        position: relative;
        z-index: 10;
    }

    .step-dot.active {
        background: var(--accent);
        border-color: rgba(34, 197, 94, 0.4);
        box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
    }

    .step-dot.cancelled {
        background: #ef4444;
        border-color: rgba(239, 68, 68, 0.4);
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
    }

    .content-wrapper {
        max-width: 1000px;
        margin: 0 auto;
    }
</style>

<main class="content-wrapper px-6 py-4">
    <div class="mb-8">
        <div class="flex items-center gap-2 text-[10px] uppercase font-bold tracking-widest text-zinc-500 mb-4">
            <a href="/profile">My Account</a> <span>/</span> <a href="/orders">Orders</a> <span>/</span> <span class="text-zinc-300">Order Details</span>
        </div>
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-black uppercase tracking-tight"><%= order.orderId %></h1>
                <p class="text-[11px] text-zinc-500 font-bold uppercase mt-1">Placed on <%= new Date(order.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) %> at <%= new Date(order.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %></p>
            </div>
            <div class="flex gap-3">
                <a href="/orders" class="px-5 py-2 bg-white/5 border border-white/10 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-white/10 transition-all flex items-center">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Back to Orders
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-7 space-y-6">
            
            <div class="glass-card p-6">
                <h3 class="text-[11px] font-black uppercase tracking-widest mb-8 flex items-center gap-2 text-zinc-400">
                    <i class="fa-solid fa-truck-fast text-[#22c55e]"></i> Order Tracking
                </h3>
                
                <div class="relative timeline-container ml-2 space-y-10">
                    <% if (order.orderStatus === 'CANCELLED') { %>
                        <div class="flex gap-6 items-start">
                            <div class="step-dot cancelled"></div>
                            <div>
                                <h4 class="text-[11px] font-black uppercase tracking-widest text-red-500">Order Cancelled</h4>
                                <p class="text-[10px] text-zinc-500 mt-1">This order was cancelled and will not be processed.</p>
                            </div>
                        </div>
                    <% } else { %>
                        <div class="flex gap-6 items-start">
                            <div class="step-dot active"></div>
                            <div>
                                <h4 class="text-[11px] font-black uppercase tracking-widest">Order Placed</h4>
                                <p class="text-[10px] text-zinc-500 mt-1">Your order has been placed successfully.</p>
                                <p class="text-[9px] text-zinc-600 font-bold"><%= new Date(order.createdAt).toDateString() %></p>
                            </div>
                        </div>

                        <div class="flex gap-6 items-start">
                            <div class="step-dot <%= (order.orderStatus !== 'PENDING') ? 'active' : '' %>"></div>
                            <div class="<%= (order.orderStatus === 'PENDING') ? 'opacity-40' : '' %>">
                                <h4 class="text-[11px] font-black uppercase tracking-widest">Processing</h4>
                                <p class="text-[10px] text-zinc-500 mt-1">Seller is preparing your order for shipment.</p>
                            </div>
                        </div>

                        <div class="flex gap-6 items-start">
                            <div class="step-dot <%= (order.orderStatus === 'SHIPPED' || order.orderStatus === 'DELIVERED') ? 'active' : '' %>"></div>
                            <div class="<%= (order.orderStatus !== 'SHIPPED' && order.orderStatus !== 'DELIVERED') ? 'opacity-40' : '' %>">
                                <h4 class="text-[11px] font-black uppercase tracking-widest">Shipped</h4>
                                <p class="text-[10px] text-zinc-500 mt-1">Package will be handed over to courier partner.</p>
                            </div>
                        </div>

                        <div class="flex gap-6 items-start">
                            <div class="step-dot <%= (order.orderStatus === 'DELIVERED') ? 'active' : '' %>"></div>
                            <div class="<%= (order.orderStatus !== 'DELIVERED') ? 'opacity-40' : '' %>">
                                <h4 class="text-[11px] font-black uppercase tracking-widest">Delivered</h4>
                                <p class="text-[10px] text-zinc-500 mt-1">Order has been successfully delivered.</p>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-[11px] font-black uppercase tracking-widest mb-6 flex items-center gap-2 text-zinc-400">
                    <i class="fa-solid fa-box text-[#22c55e]"></i> Order Items
                </h3>
                <div class="space-y-4">
                    <% order.items.forEach(item => { %>
                        <div class="flex items-center justify-between p-4 bg-black/20 rounded-2xl border border-white/5">
                            <div class="flex items-center gap-5">
                                <div class="w-16 h-16 bg-zinc-900 rounded-xl overflow-hidden border border-white/5 p-1">
                                    <img id="img-<%= item._id %>" src="<%= item.variant.images[0].url %>" class="w-full h-full object-contain" alt="">
                                </div>
                                <div>
                                    <h4 id="name-<%= item._id %>" class="font-bold text-sm"><%= item.product.name %></h4>
                                    <p class="text-[10px] text-zinc-500 mt-1">Qty: <span id="qty-<%= item._id %>"><%= item.quantity %></span>
                                        <span class="ml-2 px-2 py-0.5 <%= (item.itemStatus === 'CANCELLED' || item.itemStatus === 'RETURNED' || item.itemStatus === 'RETURN_REQUESTED') ? 'bg-red-500/10 text-red-500' : 'bg-[#22c55e]/10 text-[#22c55e]' %> text-[8px] rounded uppercase font-black">
                                            <%= item.itemStatus %>
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-[#22c55e] mb-2 text-sm">₹<span id="price-<%= item._id %>"><%= (item.price * item.quantity).toLocaleString('en-IN') %></span></p>
                                <div class="flex gap-4">
                                    <% if (item.itemStatus === 'CANCELLED') { %>
                                        <span class="text-[10px] font-black uppercase text-zinc-500 italic">Item Cancelled</span>
                                    <% } else if (item.itemStatus === 'RETURNED' || item.itemStatus === 'RETURN_REQUESTED') { %>
                                        <button class="bg-[#22c55e] text-black px-3 py-1 rounded text-[9px] font-black uppercase">Add Review</button>
                                    <% } else if (order.orderStatus === 'DELIVERED') { %>
                                        <button onclick="handleItemReturn('<%= order._id %>', '<%= item._id %>')" class="text-[9px] font-black uppercase text-red-500 hover:underline">Return Item</button>
                                        <button class="bg-[#22c55e] text-black px-3 py-1 rounded text-[9px] font-black uppercase">Add Review</button>
                                    <% } else if (order.orderStatus !== 'CANCELLED') { %>
                                        <button onclick="handleItemAction('<%= order._id %>', '<%= item._id %>')" class="text-[9px] font-black uppercase text-red-500 hover:underline">Cancel Item</button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <div class="lg:col-span-5 space-y-6">
            <div class="glass-card p-6">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6">Order Summary</h3>
                <div class="space-y-4 text-[11px] font-bold border-b border-white/5 pb-6 mb-4">
                    <div class="flex justify-between text-zinc-400">
                        <span>Total MRP</span>
                        <span class="text-white">₹<%= order.subtotal.toLocaleString('en-IN') %></span>
                    </div>
                    <div class="flex justify-between text-[#22c55e]">
                        <span>Discount on MRP</span>
                        <span>-₹<%= order.discount.toLocaleString('en-IN') %></span>
                    </div>
                    <div class="flex justify-between text-zinc-400">
                        <span>Subtotal</span>
                        <span class="text-white">₹<%= (order.subtotal - order.discount).toLocaleString('en-IN') %></span>
                    </div>
                    <div class="flex justify-between text-zinc-400">
                        <span>Delivery Charges</span>
                        <span class="text-[#22c55e] uppercase">Free</span>
                    </div>
                    <div class="flex justify-between text-zinc-400">
                        <span>Estimated Tax</span>
                        <span class="text-white">₹<%= order.tax.toLocaleString('en-IN') %></span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <p class="text-xl font-black text-[#22c55e]">₹<%= order.totalAmount.toLocaleString('en-IN') %></p>
                    <span class="text-[9px] font-black text-zinc-600 uppercase">Total Amount</span>
                </div>
            </div>

            <div class="glass-card p-6 space-y-6">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Delivery Information</h3>
                <div class="flex gap-4 items-start">
                    <i class="fa-solid fa-location-dot text-zinc-500 mt-1"></i>
                    <div class="text-[11px] text-zinc-300">
                        <p class="text-white uppercase mb-1 font-bold">Delivery Address</p>
                        <p><%= order.shippingAddress.fullName %></p>
                        <p><%= order.shippingAddress.streetAddress %></p>
                        <p><%= order.shippingAddress.city %>, <%= order.shippingAddress.state %></p>
                    </div>
                </div>
                <div class="flex gap-4 items-center">
                    <i class="fa-solid fa-phone text-zinc-500"></i>
                    <div class="text-[11px] text-zinc-300 ">
                        <p class="text-white uppercase font-bold">Contact Number</p>
                        <p><%= order.shippingAddress.phone %></p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6 space-y-4">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-500">Payment Information</h3>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-credit-card text-[#22c55e]"></i>
                        <p class="text-[11px] font-bold text-white uppercase"><%= order.paymentMethod %></p>
                    </div>
                    <span class="text-[9px] px-2 py-0.5 bg-[#22c55e]/10 text-[#22c55e] rounded font-black uppercase"><%= order.paymentStatus %></span>
                </div>

                <div class="pt-4 border-t border-white/5 space-y-3">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2">Order Actions</h3>
                    <button class="w-full bg-[#22c55e] text-black py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:brightness-110 transition-all flex items-center justify-center gap-2">
                        <a href="/orders/<%= order._id %>/invoice"><i class="fa-solid fa-download"></i> Download Invoice</a>
                    </button>
                    
                    <% if (order.orderStatus === 'DELIVERED') { %>
                        <% if (order.items.every(item => item.itemStatus !== 'RETURN_REQUESTED' && item.itemStatus !== 'RETURNED')) { %>
                            <button onclick="handleFullOrderReturn('<%= order._id %>', '<%= order.orderId %>')" class="w-full border border-red-500/30 text-red-500 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-500/10 transition-all">
                                <i class="fa-solid fa-rotate-left mr-2"></i> Return Full Order
                            </button>
                        <% } %>
                    <% } else if (order.orderStatus !== 'CANCELLED' && order.orderStatus !== 'RETURNED' && order.orderStatus !== 'RETURN_REQUESTED') { %>
                        <button onclick="handleFullOrderAction('<%= order._id %>')" class="w-full border border-red-500/30 text-red-500 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-500/10 transition-all">
                            <i class="fa-solid fa-circle-xmark mr-2"></i> Cancel Order
                        </button>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
async function executeAction(url, body) {
    try {
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
            Swal.fire({ icon: "success", title: "Success", background: "#121513", color: "#fff", showConfirmButton: false, timer: 1500 })
            .then(() => window.location.reload());
        } else {
            throw new Error(data.message);
        }
    } catch (err) {
        Swal.fire({ icon: "error", title: "Error", text: err.message, background: "#121513", color: "#fff" });
    }
}

async function handleItemReturn(orderId, itemId) {
    const name = document.getElementById(`name-${itemId}`).innerText;
    const img = document.getElementById(`img-${itemId}`).src;
    const qty = document.getElementById(`qty-${itemId}`).innerText;
    const price = document.getElementById(`price-${itemId}`).innerText;

    const { value: formValues } = await Swal.fire({
        title: '<span style="font-size: 16px; font-weight: 800; text-transform: uppercase;">Return Item</span>',
        background: "#121513",
        color: "#fff",
        html: `
            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); text-align: left;">
                <img src="${img}" style="width: 60px; height: 60px; object-fit: contain; background: #000; border-radius: 8px; padding: 5px;">
                <div>
                    <p style="margin: 0; font-weight: 700; font-size: 13px;">${name}</p>
                    <p style="margin: 3px 0 0 0; font-size: 11px; color: #888;">Qty: ${qty} | Price: ₹${price}</p>
                </div>
            </div>
            <div style="text-align: left;">
                <label style="font-size: 10px; font-weight: 800; text-transform: uppercase; color: #888; display: block; margin-bottom: 8px;">Reason for Return *</label>
                <textarea id="return-reason" class="swal2-textarea" style="margin: 0; width: 100%; background: #000; border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 12px; border-radius: 8px; min-height: 100px;" placeholder="Please provide a detailed reason..."></textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Submit Return',
        confirmButtonColor: '#22c55e',
        preConfirm: () => {
            const reason = document.getElementById('return-reason').value;
            if (!reason) { Swal.showValidationMessage('Please provide a reason'); }
            return reason;
        }
    });

    if (formValues) {
        executeAction(`/orders/${orderId}/return`, { itemId, reason: formValues });
    }
}

async function handleFullOrderReturn(orderId, displayOrderId) {
    const { value: reason } = await Swal.fire({
        title: '<span style="font-size: 16px; font-weight: 800; text-transform: uppercase;">Return Full Order</span>',
        background: "#121513",
        color: "#fff",
        html: `
            <div style="padding: 15px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; margin-bottom: 20px; text-align: left;">
                <p style="margin: 0; font-weight: 700; font-size: 12px; color: #ef4444;">Returning Order: ${displayOrderId}</p>
            </div>
            <div style="text-align: left;">
                <label style="font-size: 10px; font-weight: 800; text-transform: uppercase; color: #888; display: block; margin-bottom: 8px;">Reason for Full Return *</label>
                <textarea id="full-return-reason" class="swal2-textarea" style="margin: 0; width: 100%; background: #000; border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 12px; border-radius: 8px; min-height: 100px;" placeholder="Reason..."></textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Submit Return',
        confirmButtonColor: '#22c55e',
        preConfirm: () => {
            const val = document.getElementById('full-return-reason').value;
            if (!val) { Swal.showValidationMessage('Reason required'); }
            return val;
        }
    });

    if (reason) executeAction(`/orders/${orderId}/return`, { reason });
}

async function handleItemAction(orderId, itemId) {
    const confirm = await Swal.fire({ title: "Cancel this item?", text: "This action cannot be undone.", icon: "warning", showCancelButton: true, confirmButtonText: "Yes, cancel it", background: "#121513", color: "#fff", confirmButtonColor: "#ef4444" });
    if (confirm.isConfirmed) executeAction(`/orders/${orderId}/cancel-item`, { itemId });
}

async function handleFullOrderAction(orderId) {
    const confirm = await Swal.fire({ title: "Cancel full order?", icon: "warning", showCancelButton: true, confirmButtonText: "Yes, cancel order", background: "#121513", color: "#fff", confirmButtonColor: "#ef4444" });
    if (confirm.isConfirmed) executeAction(`/orders/${orderId}/cancel`, {});
}
</script>