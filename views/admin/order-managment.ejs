<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<link rel="stylesheet" href="/admin/styles/order-managment.css">

<%- include('../partials/adminSidebar') %>

<main class="flex-1 p-10 bg-[#050505]">
  <header class="mb-3">
    <nav class="mb-4">
      <ol class="flex items-center gap-2 text-[10px] uppercase tracking-widest text-gray-500">
        <li>
          <a href="/admin/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        </li>
        <span class="text-gray-700">/</span>
        <li>
          <a href="/admin/orders" class="hover:text-white transition-colors">Orders</a>
        </li>
      </ol>
    </nav>

    <h2 class="text-3xl font-bold text-white tracking-tight">Orders</h2>
    <p class="text-sm text-gray-500">Manage and track customer watch orders.</p>
  </header>

  <section class="bg-[#1A1D1A] border border-white/[0.03] rounded-3xl p-4 mb-4">
    <div class="flex items-center gap-2 mb-6">
      <h3 class="text-sm font-semibold text-white">Filter Orders</h3>
    </div>

    <form action="/admin/orders" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
      <div class="space-y-2">
        <label class="text-[10px] font-bold text-gray-600 uppercase tracking-wider">Search</label>
        <input type="text" name="search" value="<%= query.search %>" placeholder="Order ID or Customer..." class="w-full bg-black/60 border border-white/10 rounded-xl p-3 text-xs text-white focus:outline-none focus:border-green-500/50 transition-all">
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-bold text-gray-600 uppercase tracking-wider">Order Status</label>
        <select name="orderStatus" class="w-full bg-black/60 border border-white/10 rounded-xl p-3 text-xs text-white focus:outline-none">
          <option value="ALL" <%= query.orderStatus === 'ALL' ? 'selected' : '' %>>All Statuses</option>
          <option value="CONFIRMED" <%= query.orderStatus === 'CONFIRMED' ? 'selected' : '' %>>Confirmed</option>
          <option value="DELIVERED" <%= query.orderStatus === 'DELIVERED' ? 'selected' : '' %>>Delivered</option>
          <option value="CANCELLED" <%= query.orderStatus === 'CANCELLED' ? 'selected' : '' %>>Cancelled</option>
        </select>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-bold text-gray-600 uppercase tracking-wider">Payment Status</label>
        <select name="paymentStatus" class="w-full bg-black/60 border border-white/10 rounded-xl p-3 text-xs text-white focus:outline-none">
          <option value="ALL" <%= query.paymentStatus === 'ALL' ? 'selected' : '' %>>All Payments</option>
          <option value="PAID" <%= query.paymentStatus === 'PAID' ? 'selected' : '' %>>Paid</option>
          <option value="PENDING" <%= query.paymentStatus === 'PENDING' ? 'selected' : '' %>>Pending</option>
          <option value="FAILED" <%= query.paymentStatus === 'FAILED' ? 'selected' : '' %>>Failed</option>
        </select>
      </div>

      <div class="space-y-2">
        <label class="text-[10px] font-bold text-gray-600 uppercase tracking-wider">Sort</label>
        <select name="sort" class="w-full bg-black/60 border border-white/10 rounded-xl p-3 text-xs text-white focus:outline-none">
          <option value="newest" <%= query.sort === 'newest' ? 'selected' : '' %>>Newest</option>
          <option value="oldest" <%= query.sort === 'oldest' ? 'selected' : '' %>>Oldest</option>
          <option value="amount_high" <%= query.sort === 'amount_high' ? 'selected' : '' %>>Amount ↑</option>
          <option value="amount_low" <%= query.sort === 'amount_low' ? 'selected' : '' %>>Amount ↓</option>
        </select>
      </div>

      <div class="flex gap-1">
        <button type="submit" class="flex-1 text-[12px] bg-[#22c55e] hover:bg-green-400 text-black font-bold py-2 rounded-2xl transition-all shadow-[0_0_20px_rgba(34,197,94,0.1)]">
          Search
        </button>
        <button type="button" onclick="window.location.href='/admin/orders'" class="px-6 bg-[#1a1a1a] hover:bg-white/10 text-gray-400 rounded-2xl text-xs font-medium border border-white/5">
          Clear
        </button>
      </div>
    </form>
  </section>

  <section class="bg-[#1A1D1A] border border-white/[0.03] rounded-3xl overflow-hidden shadow-2xl">
    <div class="overflow-x-hidden">
      <table class="w-full text-left border-collapse table-auto">
        <thead>
          <tr class="text-[10px] uppercase text-gray-500 tracking-widest border-b border-white/[0.03] bg-white/[0.01]">
            <th class="pl-6 py-5 font-bold">Order ID</th>
            <th class="px-2 py-5 font-bold">Product</th>
            <th class="px-2 py-5 font-bold">Customer</th>
            <th class="px-2 py-5 font-bold text-center">Payment</th>
            <th class="px-2 py-5 font-bold text-center">Order Status</th>
            <th class="px-2 py-5 font-bold text-center">Date</th>
            <th class="pr-6 py-5 font-bold text-right">Action</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-white/[0.03]">
          <% if (orders && orders.length > 0) { %>
            <% orders.forEach(order => { %>
              <tr class="hover:bg-white/[0.02] transition-colors whitespace-nowrap">
                <td class="pl-6 py-4 text-[#22c55e] text-[13px] font-bold">
                  <%= order.orderId %>
                </td>

                <td class="px-2 py-4">
                  <div class="flex items-center gap-3">
                    <div class="relative flex-shrink-0">
                      <div class="w-9 h-9 rounded-lg bg-black border border-white/10 overflow-hidden">
                        <img src="<%= order.items[0]?.variant?.images?.[0]?.url || '/images/placeholder.png' %>" alt="P" class="w-full h-full object-contain p-1">
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <span class="text-[12px] text-gray-200 font-medium truncate max-w-[140px]">
                        <%= order.items[0]?.product?.name || "—" %>
                      </span>
                      <% if (order.items.length > 1) { %>
                        <span class="text-[10px] text-gray-400/80 font-semibold tracking-tight">
                          +<%= order.items.length - 1 %> more items
                        </span>
                      <% } %>
                    </div>
                  </div>
                </td>

                <td class="px-2 py-4">
                  <span class="text-[12px] text-gray-300">
                    <%= order.user?.name || "Guest" %>
                  </span>
                </td>

                <td class="px-2 py-4 text-center">
                  <% 
                    let payClass = "bg-yellow-500/10 text-yellow-500 border-yellow-500/20";
                    if(order.paymentStatus === "PAID") payClass = "bg-green-500/10 text-green-500 border-green-500/20";
                    if(order.paymentStatus === "FAILED") payClass = "bg-red-500/10 text-red-500 border-red-500/20"; 
                  %>
                  <span class="px-2.5 py-0.5 border rounded-full <%= payClass %> text-[9px] font-bold uppercase">
                    <%= order.paymentStatus %>
                  </span>
                </td>

                <td class="px-2 py-4 text-center">
                  <% 
                    const hasItemReturn = order.items && order.items.some(item => item.itemStatus === "RETURN_REQUESTED");
                    const hasReturnRequest = order.orderStatus === "RETURN_REQUESTED" || hasItemReturn;

                    let orderClass = "border-neutral-500/20 text-neutral-400";
                    if(order.orderStatus === "CONFIRMED") orderClass = "border-blue-500/40 text-blue-400";
                    if(order.orderStatus === "SHIPPED") orderClass = "border-purple-500/40 text-purple-400";
                    if(order.orderStatus === "DELIVERED") orderClass = "border-green-500/40 text-green-400";
                    if(order.orderStatus === "CANCELLED") orderClass = "border-red-500/40 text-red-400";
                    if(order.orderStatus === "PENDING") orderClass = "border-yellow-500/40 text-yellow-400";
                    if(order.orderStatus === "RETURN_REQUESTED") orderClass = "border-orange-500/50 text-orange-400";
                    if(order.orderStatus === "RETURNED") orderClass = "border-red-400/20 text-gray-400 bg-white/5";
                  %>

                  <div class="relative inline-block w-36">
                    <% if (hasReturnRequest) { %>
                      <div class="absolute -top-2 -right-1 z-10 flex items-center justify-center">
                        <span class="flex h-3 w-3">
                          <span class="inline-flex rounded-full h-3 w-3 bg-orange-500 border border-black shadow-[0_0_5px_rgba(249,115,22,0.4)]"></span>
                        </span>
                      </div>
                    <% } %>

                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-[10px] opacity-40">
                      <i class="fa-solid fa-chevron-down"></i>
                    </div>

                    <% const isLocked = ['DELIVERED', 'CANCELLED', 'RETURNED'].includes(order.orderStatus) || (order.paymentMethod === 'RAZORPAY' && order.paymentStatus !== 'PAID'); %>

                    <select onchange="updateStatus('<%= order._id %>', this.value)" 
                      <%= isLocked ? 'disabled' : '' %>
                      class="appearance-none w-full bg-black/40 border <%= orderClass %> rounded-lg px-3 py-1.5 text-[10px] font-bold uppercase focus:outline-none transition-all cursor-pointer disabled:cursor-not-allowed disabled:opacity-50"
                    >
                      <% if (order.orderStatus === "RETURN_REQUESTED") { %>
                        <option value="RETURN_REQUESTED" selected hidden>Return Requested</option>
                      <% } else if (order.orderStatus === "RETURNED") { %>
                        <option value="RETURNED" selected hidden>Returned</option>
                      <% } else if (order.paymentMethod === 'RAZORPAY' && order.paymentStatus !== 'PAID') { %>
                        <option value="UNPAID" selected hidden>Unpaid</option>
                      <% } %>

                      <option value="PENDING" class="bg-[#1A1D1A] text-white" <%= order.orderStatus === "PENDING" ? "selected" : "" %>>Pending</option>
                      <option value="CONFIRMED" class="bg-[#1A1D1A] text-white" <%= order.orderStatus === "CONFIRMED" ? "selected" : "" %>>Confirmed</option>
                      <option value="SHIPPED" class="bg-[#1A1D1A] text-white" <%= order.orderStatus === "SHIPPED" ? "selected" : "" %>>Shipped</option>
                      <option value="DELIVERED" class="bg-[#1A1D1A] text-white" <%= order.orderStatus === "DELIVERED" ? "selected" : "" %>>Delivered</option>
                      <option value="CANCELLED" class="bg-[#1A1D1A] text-white" <%= order.orderStatus === "CANCELLED" ? "selected" : "" %>>Cancelled</option>
                    </select>
                  </div>
                </td>

                <td class="px-2 py-4 text-[11px] text-gray-500 text-center">
                  <%= new Date(order.createdAt).toLocaleDateString("en-IN", { day: "2-digit", month: "short" }) %>
                </td>

                <td class="pr-6 py-4 text-right">
                  <a href="/admin/orders/<%= order._id %>" class="inline-block px-4 py-2 bg-blue-500/5 hover:bg-blue-500/10 text-blue-400 rounded-xl text-[11px] font-bold border border-blue-500/20 transition-all">
                    View Details
                  </a>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="7" class="py-20 text-center">
                <div class="flex flex-col items-center justify-center gap-4">
                  <div class="w-16 h-16 bg-white/[0.02] border border-white/5 rounded-2xl flex items-center justify-center mb-2">
                    <i class="fa-solid fa-box-open text-2xl text-gray-700"></i>
                  </div>
                  <div class="space-y-1">
                    <h4 class="text-white font-semibold">No Orders Found</h4>
                    <p class="text-xs text-gray-500">We couldn't find any orders matching your criteria.</p>
                  </div>
                </div>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <% if (orders && orders.length > 0) { %>
      <div class="p-6 flex items-center justify-center bg-black/20">
        <nav id="paginationNav" class="flex items-center gap-3 justify-center">
          <% if (currentPage > 1) { %>
            <a href="/admin/orders?page=<%= currentPage - 1 %>&search=<%= query.search %>&orderStatus=<%= query.orderStatus %>&paymentStatus=<%= query.paymentStatus %>&sort=<%= query.sort %>" class="w-10 h-10 flex items-center justify-center rounded-xl border border-white/5 bg-white/[0.02] text-gray-500 hover:text-[#4ade80] hover:border-[#4ade80]/30 transition-all duration-300">
              <i class="fa-solid fa-arrow-left text-[10px]"></i>
            </a>
          <% } %>

          <div class="flex items-center bg-[#0a0a0a] rounded-xl border border-white/5 p-1 gap-1">
            <div class="px-4 h-8 flex items-center justify-center rounded-lg bg-[#4ade80] text-black font-black text-[11px] shadow-[0_0_15px_rgba(74,222,128,0.2)]">
              <%= currentPage %>
            </div>
            <% if (currentPage < totalPages) { %>
              <a href="/admin/orders?page=<%= totalPages %>&search=<%= query.search %>&orderStatus=<%= query.orderStatus %>&paymentStatus=<%= query.paymentStatus %>&sort=<%= query.sort %>" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-white hover:bg-white/5 transition text-[11px] font-bold">
                <%= totalPages %>
              </a>
            <% } %>
          </div>

          <% if (currentPage < totalPages) { %>
            <a href="/admin/orders?page=<%= currentPage + 1 %>&search=<%= query.search %>&orderStatus=<%= query.orderStatus %>&paymentStatus=<%= query.paymentStatus %>&sort=<%= query.sort %>" class="w-10 h-10 flex items-center justify-center rounded-xl border border-white/5 bg-white/[0.02] text-gray-500 hover:text-[#4ade80] hover:border-[#4ade80]/30 transition-all duration-300">
              <i class="fa-solid fa-arrow-right text-[10px]"></i>
            </a>
          <% } %>
        </nav>
      </div>
    <% } %>
  </section>
</main>

<script src="/admin/js/order-managment.js"></script>
