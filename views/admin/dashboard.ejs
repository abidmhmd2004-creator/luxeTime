<style>
  /* Your requested card color */
  .bg-card {
    background-color: #161b1b;
  }

  /* Custom Scrollbar for the content area */
  .custom-scroll::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .custom-scroll::-webkit-scrollbar-track {
    background: #0d0f0d;
  }

  .custom-scroll::-webkit-scrollbar-thumb {
    background: #262626;
    border-radius: 10px;
  }

  .custom-scroll::-webkit-scrollbar-thumb:hover {
    background: #333333;
  }

  /* Makes the entire date input clickable to open the calendar */
  input[type='date'] {
    position: relative;
    color-scheme: dark;
  }

  input[type='date']::-webkit-calendar-picker-indicator {
    background: transparent;
    bottom: 0;
    color: transparent;
    cursor: pointer;
    height: auto;
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
    width: auto;
    z-index: 2;
  }

  /* Prevent layout shift when dates appear */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<div class="flex w-full h-screen overflow-y-auto bg-[#0d0f0d]">
  <%- include('../partials/adminSidebar') %>

  <main class="flex-1 h-full p-5 space-y-5 overflow-y-auto text-white custom-scroll">
    <div
      class="flex flex-col lg:flex-row justify-between bg-card items-start lg:items-center border-b border-neutral-700 pb-4 gap-4 top-0 z-10 p-4 rounded-t-lg"
    >
      <div class="flex-shrink-0">
        <h1 class="text-lg font-bold tracking-wider uppercase">Sales & Revenue Report</h1>
        <p class="text-[11px] text-neutral-400">
          Detailed analytics of orders, discounts, and performance
        </p>
      </div>

      <div
        class="flex items-center gap-3 overflow-x-auto no-scrollbar w-full lg:w-auto pb-2 lg:pb-0"
      >
        <div
          class="flex bg-neutral-800 rounded-lg p-0.5 text-[10px] text-neutral-400 flex-shrink-0"
        >
          <button data-range="daily" class="range-btn px-2.5 py-1 rounded-md">Daily</button>
          <button data-range="weekly" class="range-btn px-2.5 py-1 rounded-md">Weekly</button>
          <button data-range="yearly" class="range-btn px-2.5 py-1 rounded-md">Yearly</button>
          <button id="customBtn" class="px-2.5 py-1 rounded-md flex items-center gap-1">
            <span class="material-symbols-outlined text-[10px]">calendar_month</span> Custom
          </button>
        </div>

        <div
          id="customDateBox"
          class="hidden flex-shrink-0 flex items-center gap-2 bg-neutral-800/50 p-1 rounded-lg border border-neutral-700"
        >
          <div class="relative flex items-center">
            <input
              type="date"
              id="startDate"
              class="bg-neutral-900 border border-neutral-700 text-[10px] pl-2 pr-7 py-1 rounded outline-none focus:border-[#4ade80] w-28"
            />
            <span
              class="material-symbols-outlined text-[12px] absolute right-2 pointer-events-none text-neutral-500"
              >calendar_today</span
            >
          </div>

          <span class="text-neutral-600 text-[10px]">to</span>

          <div class="relative flex items-center">
            <input
              type="date"
              id="endDate"
              class="bg-neutral-900 border border-neutral-700 text-[10px] pl-2 pr-7 py-1 rounded outline-none focus:border-[#4ade80] w-28"
            />
            <span
              class="material-symbols-outlined text-[12px] absolute right-2 pointer-events-none text-neutral-500"
              >calendar_today</span
            >
          </div>

          <button
            id="applyCustom"
            class="px-3 py-1 bg-[#4ade80] text-black text-[10px] font-bold rounded hover:bg-[#38a169] transition flex-shrink-0"
          >
            Apply
          </button>
        </div>

        <div class="h-6 w-[1px] bg-neutral-700 flex-shrink-0"></div>

        <div class="flex items-center gap-2 flex-shrink-0">
          <a
            href="/admin/reports/pdf?<%= new URLSearchParams(query).toString() %>"
            class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg border border-neutral-700 hover:bg-neutral-800 text-[10px] text-neutral-300 transition whitespace-nowrap"
          >
            <span class="material-symbols-outlined text-sm">picture_as_pdf</span> PDF
          </a>

          <a
            href="/admin/reports/excel?<%= new URLSearchParams(query).toString() %>"
            class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-[#4ade80]/10 text-[#4ade80] border border-[#4ade80]/20 hover:bg-[#4ade80] hover:text-black text-[10px] font-bold transition whitespace-nowrap"
          >
            <span class="material-symbols-outlined text-sm">description</span> EXCEL
          </a>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-card p-4 rounded-xl border border-neutral-800 space-y-1">
        <p class="text-[10px] text-neutral-400 uppercase font-semibold">Total Sales Count</p>
        <h2 class="text-lg font-black"><%= summary.totalOrders %></h2>
        <p class="text-[9px] text-[#4ade80] flex items-center gap-1">
          <span class="material-symbols-outlined text-[10px]">trending_up</span> +8% vs last month
        </p>
      </div>
      <div class="bg-card p-4 rounded-xl border border-neutral-800 space-y-1">
        <p class="text-[10px] text-neutral-400 uppercase font-semibold">Gross Amount</p>
        <h2 class="text-lg font-black">₹<%= summary.grossAmount.toLocaleString() %></h2>
      </div>
      <div
        class="bg-card p-4 rounded-xl border border-neutral-800 ring-1 ring-[#4ade80]/20 space-y-1"
      >
        <p class="text-[10px] text-[#4ade80] uppercase font-semibold">Net Revenue</p>
        <h2 class="text-lg font-black text-white">₹<%= summary.netRevenue.toLocaleString() %></h2>
      </div>
      <div class="bg-card p-4 rounded-xl border border-neutral-800 space-y-1">
        <p class="text-[10px] text-neutral-400 uppercase font-semibold">Avg. Value</p>
        <h2 class="text-lg font-black">
          ₹<%= Math.round(summary.avgOrderValue).toLocaleString() %>
        </h2>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <div class="lg:col-span-2 bg-card p-5 rounded-xl border border-neutral-800 shadow-lg">
        <div class="flex justify-between items-center border-b border-neutral-700 pb-2 mb-4">
          <h3 class="text-xs font-bold text-neutral-200">Revenue Trend</h3>
          <span class="text-[9px] text-neutral-500 italic uppercase">Values in Actuals</span>
        </div>
        <div class="h-48">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>

      <div class="bg-card p-5 rounded-xl border border-neutral-800 shadow-lg">
        <h3
          class="text-xs font-bold text-neutral-200 border-b border-neutral-700 pb-2 mb-4 text-center"
        >
          Sales by Color
        </h3>
        <div class="flex flex-col items-center">
          <div class="relative w-32 h-32 mb-4">
            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
              <circle
                cx="50"
                cy="50"
                r="40"
                stroke="#262626"
                stroke-width="10"
                fill="transparent"
              />
              <circle
                cx="50"
                cy="50"
                r="40"
                stroke="#4ade80"
                stroke-width="10"
                fill="transparent"
                stroke-dasharray="251.2"
                stroke-dashoffset="100"
              />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span class="text-lg font-black"> <%= summary.totalOrders %> </span>
              <span class="text-[8px] text-neutral-500 uppercase tracking-widest">Orders</span>
            </div>
          </div>
          <div class="w-full space-y-1">
            <% if(salesByColor && salesByColor.length> 0) { %> <% salesByColor.forEach(color=> { %>
            <div class="flex justify-between text-[10px] text-neutral-400">
              <span class="capitalize"> <%= color._id %> </span>
              <span class="font-bold"> <%= color.units %> units </span>
            </div>
            <% }) %>
            <% } else { %>
            <p class="text-[9px] text-center text-neutral-600 uppercase">No Data</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-card rounded-xl shadow-lg border border-neutral-800 overflow-hidden">
      <div class="p-3 border-b border-neutral-700 flex justify-between items-center bg-black/20">
        <h3 class="text-xs font-bold text-neutral-200 uppercase tracking-widest">
          Detailed Sales Ledger
        </h3>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-[11px] text-neutral-300">
          <thead class="bg-neutral-800/30 text-[10px] text-neutral-500 uppercase tracking-wider">
            <tr>
              <th class="px-4 py-2 text-left">Date</th>
              <th class="px-4 py-2 text-left">Order ID</th>
              <th class="px-4 py-2 text-left">Customer</th>
              <th class="px-4 py-2 text-right">Amount</th>
              <th class="px-4 py-2 text-right text-[#4ade80]">Net Total</th>
              <th class="px-4 py-2 text-center">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-800">
            <% if (ledger && ledger.length> 0) { %> <% ledger.forEach(order=> { %>
            <tr class="hover:bg-neutral-800/40 transition">
              <td class="px-4 py-3"><%= new Date(order.createdAt).toDateString() %></td>
              <td class="px-4 py-3 font-bold"><%= order.orderId %></td>
              <td class="px-4 py-3"><%= order.user ? order.user.name : 'Guest User' %></td>
              <td class="px-4 py-3 text-right">₹<%= order.subtotal.toLocaleString() %></td>
              <td class="px-4 py-3 text-right font-black">
                ₹<%= order.totalAmount.toLocaleString() %>
              </td>
              <td class="px-4 py-3 text-center">
                <span
                  class="px-2 py-0.5 rounded bg-[#4ade80]/10 text-[#4ade80] text-[9px] font-bold uppercase tracking-tighter"
                >
                  <%= order.paymentStatus %>
                </span>
              </td>
            </tr>
            <% }) %>
            <% } else { %>
            <tr>
              <td colspan="6" class="px-4 py-10 text-center text-neutral-500 italic">
                <div class="flex flex-col items-center gap-2">
                  <span class="material-symbols-outlined text-2xl">folder_off</span>
                  <p class="uppercase tracking-widest text-[10px]">
                    No sales records found for this period
                  </p>
                </div>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <div
        class="p-3 border-t border-neutral-800 flex items-center justify-between bg-neutral-900/10"
      >
        <span class="text-[10px] text-neutral-500 font-medium tracking-tight"
          >Page <%= currentPage %> of <%= totalPages %>
        </span>
        <div class="flex items-center gap-1">
          <% for (let i=1; i <=totalPages; i++) { %> <% const params=new URLSearchParams(query);
          params.set("page", i); %>
          <a
            href="?<%= params.toString() %>"
            class="px-2.5 py-1 text-[10px] border rounded transition <%= i === currentPage ? 'bg-[#4ade80] text-black font-bold border-[#4ade80]' : 'text-neutral-400 border-neutral-700 hover:bg-neutral-800' %>"
          >
            <%= i %>
          </a>
          <% } %>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const revenueData = JSON.parse('<%- JSON.stringify(revenueTrend ?? []) %>');

  const ctx = document.getElementById('revenueChart');
  if (ctx && revenueData.length > 0) {
    const labels = revenueData.map((item) =>
      new Date(item._id).toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
      })
    );
    const values = revenueData.map((item) => item.revenue);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'Revenue (₹)',
            data: values,
            backgroundColor: '#38a169',
            borderRadius: 6,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            ticks: {
              color: '#737373',
              font: { size: 9 },
              callback: (v) => '₹' + v.toLocaleString(),
            },
            grid: { color: '#262626' },
          },
          x: {
            ticks: { color: '#737373', font: { size: 9 } },
            grid: { display: false },
          },
        },
      },
    });
  }

  (function () {
    const params = new URLSearchParams(window.location.search);
    const activeRange = params.get('range') || 'daily';

    document.querySelectorAll(`.range-btn[data-range="${activeRange}"]`).forEach((btn) => {
      btn.classList.add('bg-neutral-700', 'text-white', 'font-bold');
    });

    document.querySelectorAll('.range-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const newParams = new URLSearchParams();
        newParams.set('range', btn.dataset.range);
        window.location.search = newParams.toString();
      });
    });

    document.getElementById('customBtn').addEventListener('click', () => {
      document.getElementById('customDateBox').classList.toggle('hidden');
    });

    function submitCustomRange() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;

      if (!start || !end) {
        Swal.fire({
          icon: 'warning',
          title: 'Select both dates',
          text: 'Please choose start and end date',
        });
        return;
      }

      if (new Date(start) > new Date(end)) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Date Range',
          text: 'Start date cannot be after End date',
        });
        return;
      }

      const params = new URLSearchParams();
      params.set('range', 'custom');
      params.set('startDate', start);
      params.set('endDate', end);

      window.location.search = params.toString();
    }

    document.getElementById('applyCustom').addEventListener('click', submitCustomRange);

    ['startDate', 'endDate'].forEach((id) => {
      document.getElementById(id).addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          submitCustomRange();
        }
      });
    });
  })();
</script>
