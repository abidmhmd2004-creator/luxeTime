<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<style>
  .bg-card { background-color: #161b1b; }

  /* Custom Scrollbar */
  .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
  .custom-scroll::-webkit-scrollbar-track { background: #0d0f0d; }
  .custom-scroll::-webkit-scrollbar-thumb { background: #262626; border-radius: 10px; }
  .custom-scroll::-webkit-scrollbar-thumb:hover { background: #333333; }

  /* Date Input Styling */
  input[type='date'] { position: relative; color-scheme: dark; }
  input[type='date']::-webkit-calendar-picker-indicator {
    background: transparent; bottom: 0; color: transparent; cursor: pointer;
    height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; z-index: 2;
  }

  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<div class="flex w-full h-screen overflow-hidden bg-[#0d0f0d]">
  <%- include('../partials/adminSidebar') %>

  <main class="flex-1 h-full p-5 space-y-6 overflow-y-auto text-white custom-scroll">
    <div class="flex flex-col lg:flex-row justify-between bg-card items-start lg:items-center border-b border-neutral-700 pb-4 gap-4 p-4 rounded-t-lg">
      <div>
        <h1 class="text-lg font-bold tracking-wider uppercase">Sales & Revenue Report</h1>
        <p class="text-[11px] text-neutral-400">Detailed analytics of orders, discounts, and performance</p>
      </div>

      <div class="flex items-center gap-3 overflow-x-auto no-scrollbar w-full lg:w-auto">
        <div class="flex bg-neutral-800 rounded-lg p-0.5 text-[10px] text-neutral-400">
          <button data-range="daily" class="range-btn px-2.5 py-1 rounded-md">Daily</button>
          <button data-range="weekly" class="range-btn px-2.5 py-1 rounded-md">Weekly</button>
          <button data-range="yearly" class="range-btn px-2.5 py-1 rounded-md">Yearly</button>
          <button id="customBtn" class="px-2.5 py-1 rounded-md flex items-center gap-1">
            <span class="material-symbols-outlined text-[10px]">calendar_month</span> Custom
          </button>
        </div>

        <div id="customDateBox" class="hidden flex items-center gap-2 bg-neutral-800/50 p-1 rounded-lg border border-neutral-700">
          <input type="date" id="startDate" class="bg-neutral-900 border border-neutral-700 text-[10px] px-2 py-1 rounded outline-none w-28" />
          <span class="text-neutral-600 text-[10px]">to</span>
          <input type="date" id="endDate" class="bg-neutral-900 border border-neutral-700 text-[10px] px-2 py-1 rounded outline-none w-28" />
          <button id="applyCustom" class="px-3 py-1 bg-[#4ade80] text-black text-[10px] font-bold rounded">Apply</button>
        </div>

        <div class="flex items-center gap-2">
          <a href="/admin/reports/pdf?<%= new URLSearchParams(query).toString() %>" class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg border border-neutral-700 text-[10px] hover:bg-neutral-800">
            <span class="material-symbols-outlined text-sm">picture_as_pdf</span> PDF
          </a>
          <a href="/admin/reports/excel?<%= new URLSearchParams(query).toString() %>" class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-[#4ade80]/10 text-[#4ade80] border border-[#4ade80]/20 text-[10px] font-bold hover:bg-[#4ade80] hover:text-black">
            <span class="material-symbols-outlined text-sm">description</span> EXCEL
          </a>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-card p-4 rounded-xl border border-neutral-800">
        <p class="text-[10px] text-neutral-400 uppercase font-semibold">Total Sales</p>
        <h2 class="text-lg font-black"><%= summary.totalOrders %></h2>
      </div>
      <div class="bg-card p-4 rounded-xl border border-neutral-800">
        <p class="text-[10px] text-neutral-400 uppercase font-semibold">Gross Amount</p>
        <h2 class="text-lg font-black">₹<%= summary.grossAmount.toLocaleString() %></h2>
      </div>
      <div class="bg-card p-4 rounded-xl border border-neutral-800 ring-1 ring-[#4ade80]/20">
        <p class="text-[10px] text-[#4ade80] uppercase font-semibold">Net Revenue</p>
        <h2 class="text-lg font-black">₹<%= summary.netRevenue.toLocaleString() %></h2>
      </div>
      <div class="bg-card p-4 rounded-xl border border-neutral-800">
        <p class="text-[10px] text-neutral-400 uppercase font-semibold">Avg. Order Value</p>
        <h2 class="text-lg font-black">₹<%= Math.round(summary.avgOrderValue).toLocaleString() %></h2>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <div class="lg:col-span-2 bg-card p-5 rounded-xl border border-neutral-800">
        <h3 class="text-xs font-bold text-neutral-200 border-b border-neutral-700 pb-2 mb-4">Revenue Trend</h3>
        <div class="h-56">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>

      <div class="bg-card p-5 rounded-xl border border-neutral-800">
        <h3 class="text-xs font-bold text-neutral-200 border-b border-neutral-700 pb-2 mb-4 text-center">Sales by Color</h3>
        <div class="flex flex-col items-center">
          <div class="relative w-40 h-40 mb-6">
            <canvas id="colorDonutChart"></canvas>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
              <span class="text-lg font-black"><%= summary.totalOrders %></span>
              <span class="text-[8px] text-neutral-500 uppercase tracking-widest">Orders</span>
            </div>
          </div>
          <div class="w-full space-y-2">
            <% if(salesByColor && salesByColor.length > 0) { %>
              <% salesByColor.forEach(color => { %>
                <div class="flex justify-between text-[10px] border-b border-neutral-800 pb-1">
                  <span class="capitalize text-neutral-400 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" style="background-color: <%= color._id.toLowerCase() %>"></span>
                    <%= color._id %>
                  </span>
                  <span class="font-bold text-neutral-200"><%= color.units %> units</span>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-[9px] text-center text-neutral-600 uppercase">No Data</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-card p-5 rounded-xl border border-neutral-800 shadow-lg">
      <h3 class="text-xs font-bold text-neutral-200 uppercase tracking-widest border-b border-neutral-700 pb-3 mb-4">Top 5 Selling Products</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-[11px]">
          <thead class="text-neutral-500 uppercase">
            <tr class="text-left border-b border-neutral-800">
              <th class="px-4 py-2">Product</th>
              <th class="px-4 py-2">Units Sold</th>
              <th class="px-4 py-2">Revenue</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-800 text-neutral-300">
            <% topProducts.forEach(product => { %>
              <tr class="hover:bg-neutral-800/30">
                <td class="px-4 py-3 font-medium"><%= product.name %></td>
                <td class="px-4 py-3"><%= product.totalUnitsSold %></td>
                <td class="px-4 py-3 font-bold text-[#4ade80]">₹<%= product.totalRevenue.toLocaleString() %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-card rounded-xl border border-neutral-800 overflow-hidden">
      <div class="p-4 border-b border-neutral-700 bg-black/20">
        <h3 class="text-xs font-bold uppercase tracking-widest">Detailed Sales Ledger</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-[11px]">
          <thead class="bg-neutral-800/30 text-neutral-500 uppercase">
            <tr>
              <th class="px-4 py-3 text-left">Date</th>
              <th class="px-4 py-3 text-left">Order ID</th>
              <th class="px-4 py-3 text-left">Customer</th>
              <th class="px-4 py-3 text-right">Net Total</th>
              <th class="px-4 py-3 text-center">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-800 text-neutral-300">
            <% if (ledger && ledger.length > 0) { %>
              <% ledger.forEach(order => { %>
                <tr class="hover:bg-neutral-800/40">
                  <td class="px-4 py-3"><%= new Date(order.createdAt).toDateString() %></td>
                  <td class="px-4 py-3 font-bold text-neutral-200"><%= order.orderId %></td>
                  <td class="px-4 py-3"><%= order.user ? order.user.name : 'Guest' %></td>
                  <td class="px-4 py-3 text-right font-black text-[#4ade80]">₹<%= order.totalAmount.toLocaleString() %></td>
                  <td class="px-4 py-3 text-center">
                    <span class="px-2 py-0.5 rounded bg-[#4ade80]/10 text-[#4ade80] text-[9px] font-bold uppercase">
                      <%= order.paymentStatus %>
                    </span>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="p-3 border-t border-neutral-800 flex items-center justify-between">
        <span class="text-[10px] text-neutral-500">Page <%= currentPage %> of <%= totalPages %></span>
        <div class="flex gap-1">
          <% for (let i=1; i <= totalPages; i++) { %>
            <a href="?<%= new URLSearchParams({...query, page: i}).toString() %>" 
               class="px-2 py-1 text-[10px] border rounded <%= i === currentPage ? 'bg-[#4ade80] text-black border-[#4ade80]' : 'text-neutral-400 border-neutral-700' %>">
              <%= i %>
            </a>
          <% } %>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const revenueTrend = JSON.parse('<%- JSON.stringify(revenueTrend ?? []) %>');
  const salesByColor = JSON.parse('<%- JSON.stringify(salesByColor ?? []) %>');

  // Revenue Bar Chart
  const revCtx = document.getElementById('revenueChart');
  if (revCtx) {
    new Chart(revCtx, {
      type: 'bar',
      data: {
        labels: revenueTrend.map(d => new Date(d._id).toLocaleDateString('en-IN', {day:'2-digit', month:'short'})),
        datasets: [{
          data: revenueTrend.map(d => d.revenue),
          backgroundColor: '#38a169',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { grid: { color: '#262626' }, ticks: { color: '#737373', font: { size: 9 } } },
          x: { grid: { display: false }, ticks: { color: '#737373', font: { size: 9 } } }
        }
      }
    });
  }

  // Color Donut Chart
  const colorCtx = document.getElementById('colorDonutChart');
  if (colorCtx) {
    new Chart(colorCtx, {
      type: 'doughnut',
      data: {
        labels: salesByColor.map(d => d._id),
        datasets: [{
          data: salesByColor.map(d => d.units),
          backgroundColor: salesByColor.map(d => d._id.toLowerCase()),
          borderWidth: 2,
          borderColor: '#161b1b'
        }]
      },
      options: {
        cutout: '80%',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    });
  }

  // Range Selection Logic
  document.querySelectorAll('.range-btn').forEach(btn => {
    if (btn.dataset.range === (new URLSearchParams(window.location.search).get('range') || 'daily')) {
      btn.classList.add('bg-neutral-700', 'text-white');
    }
    btn.addEventListener('click', () => {
      window.location.search = `range=${btn.dataset.range}`;
    });
  });

  document.getElementById('customBtn').addEventListener('click', () => {
    document.getElementById('customDateBox').classList.toggle('hidden');
  });

  document.getElementById('applyCustom').addEventListener('click', () => {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (start && end) {
      window.location.search = `range=custom&startDate=${start}&endDate=${end}`;
    }
  });
</script>